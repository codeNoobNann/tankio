<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
<meta http-equiv="Content-Type" content="text/html; charset=Big5">
</head>
<body>
<canvas id="ctx" onmousemove="mouseFunction(event)" width="1000" height="500" style="border:1px solid #000000">you do not support canvas</canvas> 
<form id="chat-form">
    <input id="chat-input" type="text" style="width:500px"></input>
</form>
<p id="par">bad guy</p>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
    var name = prompt("暱稱 : ","noob");
    var chatform=document.getElementById("chat-form");
    var chatinput=document.getElementById("chat-input");
    var par=document.getElementById("par");
    var c = document.getElementById("ctx");
    var canvasPosition = c.getBoundingClientRect();
    var ctx = c.getContext("2d");
    var socket=io();
    var ctxHeight=500;
    var ctxWidth=1000;
    var tankHeight=20;
    var tankWidth=20;
    var bulletHeight=3;
    var bulletWidth=3;
    window.addEventListener('keydown',this.keyFunction,false);
    window.addEventListener('keyup',this.keyUpFunction,false);
    
    par.innerText=name;

    if(name == "" || name == null){
        name="noob";
    }
    socket.emit("addUser",encodeURIComponent(name));

    socket.on('new positions',function(data){
        ctx.clearRect(0,0,ctxWidth,ctxHeight);
        ctx.fillStyle="#CCCCCC";
        ctx.fillRect(900,400,100,100);
        ctx.fillStyle = "#00AAFF";
        for(var i = 0; i < data.tankinfo.length; i++){
            if(data.tankinfo[i].die==false){
                ctx.fillStyle = data.tankinfo[i].color;
                ctx.fillRect(data.tankinfo[i].x,data.tankinfo[i].y,tankHeight,tankWidth);
                ctx.fillStyle="#000000";
                ctx.font="7px Verdana";
                ctx.fillText(decodeURIComponent(data.tankinfo[i].nickname),data.tankinfo[i].x,data.tankinfo[i].y + tankHeight +10);
                ctx.fillText(decodeURIComponent(data.tankinfo[i].msg),data.tankinfo[i].x,data.tankinfo[i].y -20);
                ctx.fillStyle="#FF0000";
                ctx.font="15px Verdana";
                ctx.fillText("safezone",925,420);
                ctx.beginPath();
                ctx.moveTo(data.tankinfo[i].x,data.tankinfo[i].y-5);
                ctx.lineTo(data.tankinfo[i].x+(data.tankinfo[i].hp)*2,data.tankinfo[i].y-5);
                ctx.strokeStyle="#FF0000";
                ctx.lineWidth=2;
                ctx.stroke(); 
                ctx.beginPath();
                ctx.moveTo(data.tankinfo[i].x+tankWidth/2,data.tankinfo[i].y+tankHeight/2);
                ctx.lineTo(data.tankinfo[i].barrelx,data.tankinfo[i].barrely);
                ctx.strokeStyle="#777777";
                ctx.lineWidth=5;
                ctx.stroke(); 
            }
        }
        ctx.fillStyle = "#FF0000";
        for(var i=0; i<data.bulletinfo.length;i++){
             ctx.fillRect(data.bulletinfo[i].x,data.bulletinfo[i].y,bulletHeight,bulletWidth);
        }
        ctx.fillStyle="#555555";
       
    });
    socket.on('lose',function(){
        //alert("you die");
        par.innerText="you lose refresh to play again";
    });

    socket.on('yourPoint',function(data){
        //alert("you die");
        par.innerText=data.point.toString();
    });

    document.onkeydown = function(event) {
        var code=event.keyCode;
        switch (code) {
        case 65:
            socket.emit('keyPress',{inputId:"left",state:true});
            break;
        case 87:
            socket.emit('keyPress',{inputId:"up",state:true});
            break;
        case 68:
            socket.emit('keyPress',{inputId:"right",state:true});
            break;
        case 83:
            socket.emit('keyPress',{inputId:"down",state:true});
            break;
        case 32:
            socket.emit('keyPress',{inputId:"space",state:true});
            break;
        case 90:
            socket.emit('keyPress',{inputId:"health",state:true});
            break;
        }
    }

    document.onkeyup = function(event) {
        var code=event.keyCode;
        switch (code) {
        case 65:
            socket.emit('keyPress',{inputId:"left",state:false});
            break;
        case 87:
            socket.emit('keyPress',{inputId:"up",state:false});
            break;
        case 68:
            socket.emit('keyPress',{inputId:"right",state:false});
            break;
        case 83:
            socket.emit('keyPress',{inputId:"down",state:false});
            break;
        case 32:
            socket.emit('keyPress',{inputId:"space",state:false});
            break;    
    }
    
    }


    chatform.onsubmit = function(e){
        e.preventDefault();
        socket.emit("sendMsg",chatinput.value);
        chatinput.value="";

    }

   // document.onmousedown = function(event){
     //   socket.emit('mouseClick',{state:true});
   // }
    //document.onmouseup = function(event){
     //   socket.emit('mouseClick',{state:false});
   // }
   document.onclick = function(event){
       socket.emit('mouseClick',{state:true});
   }

    function mouseFunction(event){
        var x = event.clientX-canvasPosition.left;
        var y = event.clientY-canvasPosition.top;
        socket.emit('mousePosition',{mouseX:x,mouseY:y});
    }

</script>
</body>
</html>